<!-- views/index.ejs -->

<!DOCTYPE html>
<html lang="en">

  <head>
    <% include ./partials/head %>
  </head>

  <body class="container">

    <header>
      <% include ./partials/header %>
    </header>
    <main>
      <div class="jumbotron">
          <div align="center">
              <h1>Purdue Lab Stats</h1>
              <p>Welcome</p>
              <% console.log(debug); %>
      
              <p>Type something in the input field to search the table</p>  
            </div>
       
        <input class="form-control" id="myInput" type="text" placeholder="Search..">
        <br>

        <table class="table table-bordered" id="myTable">
          <thead>
            <tr>
              <% if (user) { %>
                <th scope="col" onclick="sortTable(0)">Favorite</th>
                <th scope="col" onclick="sortTable(1)">Building</th>
                <th scope="col" onclick="sortTable(2)">Room</th>
                <th scope="col" onclick="sortTable(3)">Machine Name</th>
                <th scope="col" onclick="sortTable(4)">OS</th>
                <th scope="col" onclick="sortTable(5)">Availability</th>
                <th scope="col" onclick="sortTable(6)">Occupants</th>
                <th scope="col" onclick="sortTable(6)">Capacity</th>
              <% } else { %>
                <th scope="col" onclick="sortTable(0)">Building</th>
                <th scope="col" onclick="sortTable(1)">Room</th>
                <th scope="col" onclick="sortTable(2)">Machine Name</th>
                <th scope="col" onclick="sortTable(3)">OS</th>
                <th scope="col" onclick="sortTable(4)">Availability</th>
                <th scope="col" onclick="sortTable(6)">Occupants</th>
                <th scope="col" onclick="sortTable(6)">Capacity</th>
              <% } %>
              
              
            </tr>
          </thead>
          <tbody id="myTable2">

            

            <% rows.forEach((row, idx) => { %>

                <tr>
                  <% if (user) { %>
                    
                    <td class='favorite'><span class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></td>
                    <td><a href='/<%= row.abbrev %>'><%= row.abbrev %></a></td>
                    <td class='room'><a href='/<%= row.abbrev %>/<%= row.room_number %>'><%= row.room_number %></a></td>
                    <td><%= row.machine_name %></td>
                    <td><%= row.OS %></td>
                    <td id="availability<%= idx %>"><%= row.availability %></td>
                    <td><%= row.occurances %></td>
                    <td><%= row.capacity %></td>
                  <% } else { %>
                    <td><a href='/<%= row.abbrev %>'><%= row.abbrev %></a></td>
                    <td class='room'><a href='/<%= row.abbrev %>/<%= row.room_number %>'><%= row.room_number %></a></td>
                    <td><%= row.machine_name %></td>
                    <td><%= row.OS %></td>
                    <td id="availability<%= idx %>"><%= row.availability %></td>
                    <td><%= row.occurances %></td>
                    <td><%= row.capacity %></td>
                  <% } %>
                   
                </tr>

            <% }) %>

          </tbody>
        </table>


        <div class="container-box">
            <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#myModal">Contact Us</button>
        </div>
        <!-- Modal -->
        <div id="myModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">
                            Send Email to lab user!
                        </h4>
                    </div>
                    <div class="modal-body">
                        <form action="/send-email" method="post" id="reused_form">
                            <p> Send your message to the lab user in the form below. </p>
                            <div class="form-group">
                                <label for="subject"> Name:</label>
                                <input type="text" class="form-control" id="subject" name="subject" required maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="from"> Your Email:</label>
                                <input type="email" class="form-control" id="from" name="from" required maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="to"> Send to:</label>
                                <input type="email" class="form-control" id="to" name="to" required maxlength="50">
                            </div>
                            <div class="form-group">
                                <label for="body"> Message:</label>
                                <textarea class="form-control" type="textarea" name="message" id="message" placeholder="Your Message Here" maxlength="6000" rows="7"></textarea>
                            </div>
                            <button type="submit" class="btn btn-lg btn-success btn-block" id="btnContactUs">Post It! &rarr;</button>
                        </form>
                        <div id="success_message" style="width:100%; height:100%; display:none; "> <h3>Sent your message successfully!</h3> </div>
                        <div id="error_message" style="width:100%; height:100%; display:none; "> <h3>Error</h3> Sorry there was an error sending your form. </div>
                    </div>
                </div>
            </div>
        </div>
        

        <script>
        $(document).ready(function(){
          $("#myInput").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#myTable2 tr").filter(function() {
              $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
          });
          var num_rows = $("#row_length").text
          //alert('hello1');
          var i;
          for(i = 0; i < num_rows; i++) {
            alert('hello2');
            $("#availability0").onload(function() {

            })
          }
        });

     
       
       

        $(".favorite").click(function() {
          
          var $row = $(this).closest("tr");    // Find the row
          var $text = $row.find(".room").text(); // Find the text
        
          var $data = {
            room: $text,
            favorite: 1 // this variable is dependent on the color
          }

          alert($text);

          $.ajax({
            type: "POST",
            url: '/favorite/addFavorite',
            data: $data,
            success: null,
            dataType: null
          });

          // Change the color to opposite of what it is now
          // call endpoint to add to favorite
          
        });

        

        function sortTable(n) {
          var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
          table = document.getElementById("myTable");
          switching = true;
          //Set the sorting direction to ascending:
          dir = "asc"; 
          /*Make a loop that will continue until
          no switching has been done:*/
          while (switching) {
            //start by saying: no switching is done:
            switching = false;
            rows = table.getElementsByTagName("TR");
            /*Loop through all table rows (except the
            first, which contains table headers):*/
            for (i = 1; i < (rows.length - 1); i++) {
              //start by saying there should be no switching:
              shouldSwitch = false;
              /*Get the two elements you want to compare,
              one from current row and one from the next:*/
              x = rows[i].getElementsByTagName("TD")[n];
              y = rows[i + 1].getElementsByTagName("TD")[n];
              console.log("x: " + x.innerHTML);
              console.log("y: " + y.innerHTML);
              /*check if the two rows should switch place,
              based on the direction, asc or desc:*/
              if (dir == "asc") {
                if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                  //if so, mark as a switch and break the loop:
                  shouldSwitch= true;
                  break;
                }
              } else if (dir == "desc") {
                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                  //if so, mark as a switch and break the loop:
                  shouldSwitch = true;
                  break;
                }
              }
            }
            if (shouldSwitch) {
              /*If a switch has been marked, make the switch
              and mark that a switch has been done:*/
              rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
              switching = true;
              //Each time a switch is done, increase this count by 1:
              switchcount ++;      
            } else {
              /*If no switching has been done AND the direction is "asc",
              set the direction to "desc" and run the while loop again.*/
              if (switchcount == 0 && dir == "asc") {
                dir = "desc";
                switching = true;
              }
            }
          }
        }

        </script>



      </div>
    </main>


    <footer>
      <% include ./partials/footer %>
    </footer>

  </body>

</html>
